local koyMenu = false
local defaultObje = {
    ["Hospital Flip"]={{coords={x=224.8411865234375,y=-674.5681762695313,z=36.36308288574219},rotation={x=-3.648721933364868,y=-0.026488540694117547,z=159.73965454101563},hash=1867879106},{coords={x=213.96304321289063,y=-698.029541015625,z=34.90790557861328},rotation={x=-2.6714637613167725e-8,y=2.899998664855957,z=-94.49884796142578},hash=-1228223417},{coords={x=233.12818908691407,y=-656.4044189453125,z=37.723541259765628},rotation={x=-1.8995723724365235,y=-3.411050796508789,z=99.7782974243164},hash=-1228223417},{coords={x=214.2658233642578,y=-702.1607666015625,z=34.72517013549805},rotation={x=-5.3381661757612167e-8,y=1.5999974012374879,z=-78.8990249633789},hash=-1228223417},{coords={x=219.0952911376953,y=-698.7713623046875,z=34.971702575683597},rotation={x=0.0,y=0.0,z=-19.799938201904298},hash=93871477},{coords={x=214.67286682128907,y=-704.2061767578125,z=34.682350158691409},rotation={x=0.0,y=0.6000000238418579,z=-78.59928894042969},hash=-1228223417},{coords={x=220.1291046142578,y=-695.8372192382813,z=35.143001556396487},rotation={x=2.1379788961439773e-7,y=-3.2999989986419679,z=70.19924926757813},hash=415536433},{coords={x=227.1432342529297,y=-660.9920043945313,z=37.2781982421875},rotation={x=0.17028595507144929,y=-3.050037145614624,z=69.2517318725586},hash=415536433},{coords={x=232.763427734375,y=-654.3407592773438,z=37.86319351196289},rotation={x=-1.8709198236465455,y=-3.4268381595611574,z=100.79780578613281},hash=-1228223417},{coords={x=232.44752502441407,y=-652.3008422851563,z=37.99783706665039},rotation={x=-2.0079538822174074,y=-3.3568928241729738,z=97.10736083984375},hash=-1228223417},{coords={x=232.31124877929688,y=-650.2639770507813,z=38.11543655395508},rotation={x=-1.3963457345962525,y=-3.6536152362823488,z=90.42951202392578},hash=-1228223417},{coords={x=217.02462768554688,y=-688.7184448242188,z=35.46622848510742},rotation={x=-5.343408133740013e-7,y=2.999998092651367,z=-110.72188568115235},hash=415536433},{coords={x=233.31590270996095,y=-658.4339599609375,z=37.60266876220703},rotation={x=-1.1662795543670655,y=-3.725477695465088,z=90.46966552734375},hash=-1228223417},{coords={x=228.3636474609375,y=-673.2533569335938,z=36.567935943603519},rotation={x=-0.02671237103641033,y=-3.6487138271331789,z=70.3318099975586},hash=415536433},{coords={x=214.9919891357422,y=-706.1929321289063,z=34.5931510925293},rotation={x=-1.0695684693473595e-7,y=3.7999978065490724,z=-83.68782043457031},hash=-1228223417},{coords={x=215.03048706054688,y=-694.1950073242188,z=35.132205963134769},rotation={x=-9.622900734029827e-7,y=3.499990224838257,z=-109.49823760986328},hash=415536433},{coords={x=223.70350646972657,y=-678.282470703125,z=36.17866897583008},rotation={x=3.200000047683716,y=-4.26886799687054e-7,z=-20.11740493774414},hash=-105439435},{coords={x=221.48939514160157,y=-692.08837890625,z=35.399932861328128},rotation={x=2.1375616654495389e-7,y=-3.099997043609619,z=69.59923553466797},hash=-1228223417},{coords={x=225.74954223632813,y=-664.6429443359375,z=37.10272216796875},rotation={x=0.09553031623363495,y=-3.6527581214904787,z=68.9256591796875},hash=-1228223417},{coords={x=232.35345458984376,y=-662.244140625,z=37.314674377441409},rotation={x=0.13653554022312165,y=-3.6438565254211427,z=70.5917739868164},hash=415536433},{coords={x=232.29257202148438,y=-649.0213623046875,z=38.148468017578128},rotation={x=3.6849727630615236,y=-1.3112540245056153,z=-0.04218301922082901},hash=93871477},{coords={x=228.22450256347657,y=-657.9819946289063,z=37.47983932495117},rotation={x=3.4534239768981935,y=-1.1947119235992432,z=-1.4148755073547364},hash=93871477},{coords={x=222.20236206054688,y=-690.1552734375,z=35.504112243652347},rotation={x=4.2717371684375396e-7,y=-2.0999979972839357,z=70.17413330078125},hash=-1228223417},{coords={x=213.97181701660157,y=-700.1066284179688,z=34.80533218383789},rotation={x=3.4723100839073597e-7,y=2.7000017166137697,z=-85.19908142089844},hash=-1228223417},{coords={x=230.364990234375,y=-667.7448120117188,z=36.941680908203128},rotation={x=0.028037767857313157,y=-3.6487035751342775,z=69.77156829833985},hash=415536433},{coords={x=222.68138122558595,y=-682.0546875,z=35.904911041259769},rotation={x=0.0,y=0.0,z=-20.09854507446289},hash=1867879106},{coords={x=219.0537109375,y=-683.2279052734375,z=35.81244659423828},rotation={x=-0.000001710737933535711,y=3.4999921321868898,z=-110.39887237548828},hash=415536433},{coords={x=225.06112670898438,y=-666.590087890625,z=36.970703125},rotation={x=-0.06496364623308182,y=-3.6534290313720705,z=72.34415435791016},hash=-1228223417},{coords={x=215.1188507080078,y=-707.3878173828125,z=34.43281173706055},rotation={x=0.0,y=0.0,z=-19.799938201904298},hash=93871477}}
}

local kayitliObjelerim = {}

RegisterNetEvent('tgiann-police:obje-menu-ac')
AddEventHandler('tgiann-police:obje-menu-ac', function(job)
	objeMenu()
end)

local koyulabilenObjeler = {
    {objeAdi = "Cone", hash = `prop_roadcone02a`},
    {objeAdi = "Light Cone", hash = `prop_mp_cone_04`},
    {objeAdi = "Barrier", hash = `prop_barrier_work05`},
    {objeAdi = "Concrete Barrier 1", hash = `Prop_Barier_Conc_05b`},
    {objeAdi = "Concrete Barrier 2", hash = `Prop_Barier_Conc_01a`},
    {objeAdi = "Direction sign", hash = `Prop_MP_Arrow_Barrier_01`},
    {objeAdi = "Shack", hash = `Prop_Air_SecHut_01`},
}

function objeMenu()
    QBCore.UI.Menu.Open('default', GetCurrentResourceName(), 'obje_ana', {
        title    = 'Object Menu',
        align    = 'left',
        elements = {
            {label = "Put Object", value = "koy"},
            {label = "Registered Objects", value = "kayitli"},
            {label = "Save Surrounding Objects", value = "kaydet"},
            {label = "Remove Nearby Object", value = "ysil"},
            {label = "Remove Surrounding Objects", value = "csil"},
        }
    }, function(data, menu)
        if data.current.value == "ysil" then
            local yakinObje = QBCore.Functions.GetClosestObject()
            local yakinObjeHash = GetEntityModel(yakinObje)
            for i=1, #koyulabilenObjeler do
                if koyulabilenObjeler[i].hash == yakinObjeHash then
                    QBCore.Functions.DeleteObject(yakinObje)
                    break
                end
            end
        elseif data.current.value == "csil" then
            butunObjeleriSil()
        elseif data.current.value == "kaydet" then
            QBCore.UI.Menu.Open('dialog', GetCurrentResourceName(), 'kaydet_obje', {
                title = "Enter a name to save"
            }, function(data2, menu2)
                if data2.value == "" then
                    QBCore.Functions.Notify("Name Cannot contain Space", "error")
                else
                    if kayitliObjelerim[data2.value] == nil and defaultObje[data2.value] == nil then
                        local objtgiannr = false
                        local yakindakiObjeler = QBCore.Functions.GetObjects()
                        kayitliObjelerim[data2.value] = {}
                        for x=1, #yakindakiObjeler do
                            local yakinObjeHash = GetEntityModel(yakindakiObjeler[x])
                            for i=1, #koyulabilenObjeler do
                                if koyulabilenObjeler[i].hash == yakinObjeHash then
                                    table.insert(kayitliObjelerim[data2.value], {hash = yakinObjeHash, coords = GetEntityCoords(yakindakiObjeler[x]), rotation = GetEntityRotation(yakindakiObjeler[x]) })
                                    objtgiannr = true
                                    break
                                end
                            end
                        end
                        if objtgiannr then
                            TriggerServerEvent("tgiann-police:obje-kaydet", kayitliObjelerim)
                            QBCore.Functions.Notify(data2.value.." Registered Objects With Names", "success")
                        else
                            QBCore.Functions.Notify("No Object Found Around You That Can Save!", "error")
                        end
                    else 
                        QBCore.Functions.Notify("An Object With This Name Already Exists!", "error")
                    end
                    menu2.close()

                end
            end, function(data2, menu2)
                menu2.close()
            end)
        elseif data.current.value == "kayitli" then
            QBCore.Functions.TriggerCallback("esx_policejob:get-obje", function(result)
                kayitliObjelerim = result
                kayitliObjelerMenu()
            end)
        elseif data.current.value == "koy" then
            menu.close()
            objeKoyMenu()
        end
    end,function(data, menu)
        menu.close()
    end)
end

function objeKoyMenu()
    local elements = {}
    for i=1, #koyulabilenObjeler do
        local obje = koyulabilenObjeler[i]
        table.insert(elements, {label = obje.objeAdi, value = obje.hash})
    end
    QBCore.UI.Menu.Open('default', GetCurrentResourceName(), 'kayitli_objeler', {
        title    = 'My Saved Objects',
        align    = 'left',
        elements = elements
    }, function(data2, menu2)
        menu2.close()
        objekoy(data2.current.value)
    end,function(data2, menu2)
        menu2.close()
    end)
end

function kayitliObjelerMenu()
    local elements = {}
    for name, data in pairs(defaultObje) do
        table.insert(elements, {label = name, value = data, isim = name, silinebilir = false})
    end 

    for name, data in pairs(kayitliObjelerim) do
        table.insert(elements, {label = name, value = data, isim = name, silinebilir = true})
    end

    QBCore.UI.Menu.Open('default', GetCurrentResourceName(), 'kayitli_objeler', {
        title    = 'My Saved Objects',
        align    = 'left',
        elements = elements
    }, function(data2, menu2)
        local elements = {{label = "Place", value = "yerlestir"}}
        if data2.current.silinebilir then
            table.insert(elements, {label = "Delete Registered Object", value = "sil"})
        end
        QBCore.UI.Menu.Open('default', GetCurrentResourceName(), 'soru_menu', {
            title    = 'Object Menu',
            align    = 'left',
            elements = elements
        }, function(data3, menu3)
            if data3.current.value == "yerlestir" then
                local objeler = data2.current.value
                if #(GetEntityCoords(PlayerPedId()) - vector3(objeler[1].coords.x, objeler[1].coords.y, objeler[1].coords.z) ) < 150 then
                    for i=1, #objeler do
                        local hash = objeler[i].hash
                        QBCore.Functions.SpawnObject(hash, {x = objeler[i].coords.x, y = objeler[i].coords.y, z = objeler[i].coords.z}, function(yeniObje)
                            FreezeEntityPosition(yeniObje, true)
                            SetEntityCoords(yeniObje, objeler[i].coords.x, objeler[i].coords.y, objeler[i].coords.z)
                            SetEntityRotation(yeniObje, objeler[i].rotation.x, objeler[i].rotation.y, objeler[i].rotation.z, false, true)
                            SetEntityAsMissionEntity(yeniObje, true, true)
                            SetModelAsNoLongerNeeded(hash)
                        end)
                    end
                    QBCore.Functions.Notify("All Objects Placed!", "success")
                else
                    QBCore.Functions.Notify("You are too far from the area where the objects will be placed!", "error")
                end
            else
                kayitliObjelerim[data2.current.isim] = nil
                TriggerServerEvent("tgiann-police:obje-kaydet", kayitliObjelerim)
            end
            QBCore.UI.Menu.CloseAll()
        end,function(data3, menu3)
            menu3.close()
        end)
        
    end,function(data2, menu2)
        menu2.close()
    end)
end

function butunObjeleriSil()
    local yakindakiObjeler = QBCore.Functions.GetObjects()
    for x=1, #yakindakiObjeler do
        local yakinObjeHash = GetEntityModel(yakindakiObjeler[x])
        for i=1, #koyulabilenObjeler do
            if koyulabilenObjeler[i].hash == yakinObjeHash then
                QBCore.Functions.DeleteObject(yakindakiObjeler[x])
                break
            end
        end
    end
end

function objekoy(hash)
    RequestModel(hash)
    while not HasModelLoaded(hash) do
        Citizen.Wait(1)
    end
    local playerPed = PlayerPedId()    
    local coords = GetOffsetFromEntityInWorldCoords(playerPed, 0.0, 3.0, 0.0)
    local obje = CreateObject(hash, coords, false, false, false)
    PlaceObjectOnGroundProperly(obje)
    FreezeEntityPosition(obje, true)
    local newObjeCoords = GetOffsetFromEntityInWorldCoords(obje, 0.0, 0.0, 0.0)
    Citizen.Wait(100)
    koyMenu = true
    while koyMenu do
        Citizen.Wait(1)
        DrawTxt(0.80, 1.44, 1.0, 1.0, 0.4, "Space: Pin to Ground, Z: Decrease Height, Arrow Keys: Move, Q-E: Flip, Enter: Save, Backspace: Cancel", 255, 255, 255, 255)

        DisableControlAction(0, 172, true)
        DisableControlAction(0, 173, true)
        DisableControlAction(0, 174, true)
        DisableControlAction(0, 175, true)
        DisableControlAction(0, 44, true)
        DisableControlAction(0, 51, true)
        DisableControlAction(0, 177, true)
        DisableControlAction(0, 215, true)
        DisableControlAction(0, 21, true)
        DisableControlAction(0, 36, true)
        DisableControlAction(0, 22, true)
        DisableControlAction(0, 20, true)
        local rotation = GetEntityRotation(obje)

        if IsDisabledControlPressed(0, 172) then -- Yukarı Ok
            newObjeCoords = GetOffsetFromEntityInWorldCoords(obje, 0.0, 0.005, 0.0)
            SetEntityCoords(obje, newObjeCoords.x, newObjeCoords.y, newObjeCoords.z)
        elseif IsDisabledControlPressed(0, 173) then -- Aşağı Ok
            newObjeCoords = GetOffsetFromEntityInWorldCoords(obje, 0.0, -0.005, 0.0)
            SetEntityCoords(obje, newObjeCoords.x, newObjeCoords.y, newObjeCoords.z)
        elseif IsDisabledControlPressed(0, 174) then -- sol Ok
            newObjeCoords = GetOffsetFromEntityInWorldCoords(obje, -0.005, 0.0, 0.0)
            SetEntityCoords(obje, newObjeCoords.x, newObjeCoords.y, newObjeCoords.z)
        elseif IsDisabledControlPressed(0, 175) then -- sağ Ok
            newObjeCoords = GetOffsetFromEntityInWorldCoords(obje, 0.005, 0.0, 0.0)
            SetEntityCoords(obje, newObjeCoords.x, newObjeCoords.y, newObjeCoords.z)
        elseif IsDisabledControlPressed(0, 20) then -- Z
            newObjeCoords = GetOffsetFromEntityInWorldCoords(obje, 0.0, 0.0, -0.005)
            SetEntityCoords(obje, newObjeCoords.x, newObjeCoords.y, newObjeCoords.z)
        elseif IsDisabledControlPressed(0, 44) then -- Q
            SetEntityRotation(obje, rotation.x, rotation.y, rotation.z+0.3, false, true)
        elseif IsDisabledControlPressed(0, 51) then -- E
            SetEntityRotation(obje,  rotation.x, rotation.y, rotation.z-0.3, false, true)
        elseif IsDisabledControlPressed(0, 21) then -- Shift
            if hash == `Prop_Air_SecHut_01` then
                SetEntityRotation(obje, rotation.x+0.1, rotation.y, rotation.z, false, true)
            else
                SetEntityRotation(obje,  rotation.x, rotation.y+0.1, rotation.z, false, true)
            end
        elseif IsDisabledControlPressed(0, 36) then -- CTRL
            if hash == `Prop_Air_SecHut_01` then
                SetEntityRotation(obje, rotation.x-0.1, rotation.y, rotation.z, false, true)
            else
                SetEntityRotation(obje,  rotation.x, rotation.y-0.1, rotation.z, false, true)
            end
        elseif IsDisabledControlPressed(0, 22) then -- Space
            PlaceObjectOnGroundProperly(obje)
            newObjeCoords = GetOffsetFromEntityInWorldCoords(obje, 0.0, 0.0, 0.0)
        elseif IsDisabledControlPressed(0, 177) then -- Backspace 
            koyMenu = false
            DeleteEntity(obje)
            SetModelAsNoLongerNeeded(hash)
            Citizen.Wait(500)
            objeKoyMenu()

        elseif IsDisabledControlPressed(0, 215) then -- Enter
            koyMenu = false
            DeleteEntity(obje)

            QBCore.Functions.SpawnObject(hash, {x = newObjeCoords.x, y = newObjeCoords.y, z = newObjeCoords.z}, function(yeniObje)
                FreezeEntityPosition(yeniObje, true)
                SetEntityCoords(yeniObje, newObjeCoords)
                SetEntityRotation(yeniObje, rotation, false, true)
                SetEntityAsMissionEntity(yeniObje, true, true)
                SetModelAsNoLongerNeeded(hash)
                Citizen.Wait(100)
                objeKoyMenu()
            end)
        end
        SetEntityVelocity(obje, 0.0, 0.0, 0.0)
    end
end

function DrawTxt(x, y, width, height, scale, text, r, g, b, a, outline)
    SetTextFont(0)
    SetTextProportional(0)
    SetTextScale(scale, scale)
    SetTextColour(r, g, b, a)
    SetTextDropShadow(0, 0, 0, 0,255)
    SetTextEdge(2, 0, 0, 0, 255)
    SetTextDropShadow()
    SetTextOutline()
    SetTextEntry("STRING")
    AddTextComponentString(text)
    DrawText(x - width/2, y - height/2 + 0.005)
end

AddEventHandler('onResourceStop', function(resourceName)
    if (GetCurrentResourceName() ~= resourceName) then
      return
    end
    QBCore.UI.Menu.CloseAll()
end)